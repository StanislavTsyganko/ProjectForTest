{% extends 'layout.html' %}

{% block title %}
    –°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞
{% endblock %}

{% block body %}
{% csrf_token %}
{% if citate.character %}
    {% if citate.character %}
    <h2>
        {{ citate.character }}: 
    </h2>
    {% endif %}
    <h1> 
        "{{ citate.content }}" 
    </h1>            
    <p>
        —É–≤–∏–¥–µ–ª–∏ {{ citate.views }} —á–µ–ª–æ–≤–µ–∫ üëÅ
    </p>
    <p>
        –ó–∞–≥—Ä—É–∂–µ–Ω–∞ {{ citate.date|date:"d.m.Y" }}
    </p>
    <p>
        –†–µ–π—Ç–∏–Ω–≥ –Ω–∞ —Å–∞–π—Ç–µ <p id="current-raiting">{{ citate.raiting }}</p>
    </p>
    <article>
        <button class="vote-button" data-citate-id="{{ citate.pk }}" data-action="Like">Like ‚ù§</button>
        <button class="vote-button" data-citate-id="{{ citate.pk }}" data-action="Dislike">Dislike üíî</button>
    </article>
    <button id="update-button">–ï—â–µ —Ü–∏—Ç–∞—Ç–∫—É?‚è©</button>

    
{% else %}
    <p>
        "–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç(("
    </p>

{% endif %}

    <script>
        document.querySelectorAll('.vote-button').forEach(button => {
            button.addEventListener('click', function(){
                const citateID =  this.dataset.citateId;
                const action  = this.dataset.action;

                if (!citateID || !action) {
                    alert('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    return;
                }

                fetch("{% url 'update_rating' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: new URLSearchParams({
                            'citate_id' : citateID,
                            'action': action                        
                        })
                    })
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('current-raiting').textContent = data.new_rating;
                        } else {
                            alert('–û—à–∏–±–∫–∞: '+ data.message);
                        }
                    })
                    .catch(error=>{
                        alert('–û—à–∏–±–∫–∞: '+ error.message);
                    });
            });
        });

        document.getElementById('update-button')?.addEventListener('click', function(){
            window.location.reload();
        })
    </script>
{% endblock %}